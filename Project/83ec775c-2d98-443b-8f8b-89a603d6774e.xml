<StructuredTextModel xmlns="http://schemas.datacontract.org/2004/07/Omron.Cxap.Modules.StructuredText.Core" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"><Text>//------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ &#xD;
//	NAME:			Forbruk                                                                                                                                                                                                                                                                          &#xD;
//	CREATOR:		Helgevold - William Veim                                                                                                                                                                                                                                                              &#xD;
//                                                                                                                                                                                                                                                                                                                            &#xD;
//------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ &#xD;
//  VERSION LOG:                                                                                                                                                                                                                                                                                                   &#xD;
//	VERSION			DATE				SIGN					DESCRIPTION                                                                                                                                                                                                                                 &#xD;
//	1.0.0				2023-03-01		William Veim			Initial release                                                                                                                                                                                                                                  &#xD;
//	2.0.0				2025-04-15		William Veim			ReWork&#xD;
//&#xD;
//===============================================================================================================================&#xD;
//&#xD;
//		BESKRIVELSE:&#xD;
//		Regner ut forbrukt mengde i dag, i går og totalt basert på måling av mengde.&#xD;
//		Ved økning i mengde tolkes dette som en påfylling og stabil mengde etter dette tolkes som fylling fullført. (Gir korrekt mengde idag selv om det har vært påfylling)&#xD;
//		Brukes til å måle forbrukt mengde av eks oxygen, lut, metanol...&#xD;
//		&#xD;
//===============================================================================================================================&#xD;
&#xD;
//Henter klokke og dato fra PLS&#xD;
Current_Time := TruncTod(DT_TO_TOD(In:=GetTime()), _SEC);&#xD;
DtToDateStruct(In:=GetTime(), DateStruct=&gt;DateStruct);&#xD;
&#xD;
//Lager puls ved midnatt&#xD;
RE_MidnightPulse(Clk:=Current_Time=TIME_OF_DAY#00:00:00.00);&#xD;
&#xD;
// Setter variabler ved programstart&#xD;
IF P_First_Run OR P_First_RunMode THEN&#xD;
	Amount_Sample := Amount;&#xD;
END_IF;&#xD;
&#xD;
AccumulatedData.EXT_Engineering.Unit := Unit;&#xD;
&#xD;
// Sjekker om det er ny dag&#xD;
IF Sample_Dag &lt;&gt; DateStruct.Day THEN&#xD;
	AccumulatedData.EXT_Statistics.Total_Yesterday := AccumulatedData.EXT_Statistics.Total_Today;&#xD;
	Clear(AccumulatedData.EXT_Statistics.Total_Today);&#xD;
END_IF;&#xD;
&#xD;
// Sjekker om det er ny uke&#xD;
IF Sample_Uke &lt;&gt; GetWeekOfYear(In:=GetTime()) THEN&#xD;
	Clear(AccumulatedData.EXT_Statistics.Total_Week);&#xD;
END_IF;&#xD;
&#xD;
// Sjekker om det er ny måned&#xD;
IF Sample_Måned &lt;&gt; DateStruct.Month THEN&#xD;
	Clear(AccumulatedData.EXT_Statistics.Total_Month);&#xD;
END_IF;&#xD;
			&#xD;
// Sjekker om det er nytt år&#xD;
IF GetWeekOfYear(In:=GetTime()) = 1 AND Sample_Uke &lt;&gt; GetWeekOfYear(In:=GetTime()) THEN&#xD;
	Clear(AccumulatedData.EXT_Statistics.Total_Year);&#xD;
END_IF;&#xD;
&#xD;
&#xD;
&#xD;
//Ved midnatt: Overfører dagens verdi til gårdsdagen, setter mengde midnatt&#xD;
IF RE_MidnightPulse.Q THEN&#xD;
	IF AccumulatedData.EXT_Statistics.Total_Today &gt; 0 THEN	&#xD;
		AccumulatedData.EXT_Statistics.Total_Yesterday := AccumulatedData.EXT_Statistics.Total_Today;&#xD;
		AccumulatedData.EXT_Statistics.Total_Year := AccumulatedData.EXT_Statistics.Total_Year + AccumulatedData.EXT_Statistics.Total_Today;&#xD;
	ELSE&#xD;
		AccumulatedData.EXT_Statistics.Total_Year := AccumulatedData.EXT_Statistics.Total_Year + AccumulatedData.EXT_Statistics.Total_Yesterday;&#xD;
	END_IF;&#xD;
	Amount_Midnight := Amount;&#xD;
	Filling_Ended := FALSE;&#xD;
END_IF;&#xD;
&#xD;
IF Filling_Ended THEN&#xD;
	AccumulatedData.EXT_Statistics.Total_Today := Amount_Midnight - Amount_BeforeFilling + Amount_AfterFilling - Amount;&#xD;
ELSE&#xD;
	AccumulatedData.EXT_Statistics.Total_Today := Amount_Midnight - Amount;&#xD;
END_IF;&#xD;
&#xD;
//Sikrer at mengde idag ikke kan gå under 0&#xD;
IF AccumulatedData.EXT_Statistics.Total_Today &lt; 0 THEN&#xD;
	AccumulatedData.EXT_Statistics.Total_Today := 0;&#xD;
END_IF;&#xD;
&#xD;
//Sjekker om det pågår fylling&#xD;
//Låser verdier for før og etter fylling&#xD;
IF Get1minClk() AND NOT Filling_Ended THEN&#xD;
	//Sjekker om påfylling starter/pågår&#xD;
	IF Amount &gt; Amount_BeforeFilling*1.011 AND NOT Filling_Ongoing THEN&#xD;
		Filling_Ongoing := TRUE;&#xD;
		Amount_BeforeFilling := Amount_Sample;&#xD;
	//Sjekker om fylling er fullført/fylling har vært&#xD;
	ELSIF Amount &gt; Amount_Sample * 0.989 AND Amount &lt; Amount_Sample * 1.011 THEN&#xD;
		Filling_Ended := TRUE;&#xD;
		Filling_Ongoing := FALSE;&#xD;
		Amount_AfterFilling := Amount;&#xD;
	END_IF;&#xD;
	Amount_Sample := Amount;&#xD;
END_IF;&#xD;
	</Text></StructuredTextModel>